# Enhanced API Gateway Configuration with Advanced Load Balancing
# Supports Layer 4 and Layer 7 load balancing, rate limiting, circuit breakers, and more

# Global rate limiting zones with different strategies
# IP-based rate limiting
limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=ip_burst:10m rate=10r/s;

# User-based rate limiting (requires authentication)
limit_req_zone $http_x_user_id zone=user_limit:10m rate=200r/s;
limit_req_zone $http_x_user_id zone=user_burst:10m rate=20r/s;

# Endpoint-specific rate limiting
limit_req_zone $binary_remote_addr zone=trading_limit:10m rate=60r/m;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=market_data_limit:10m rate=500r/m;
limit_req_zone $binary_remote_addr zone=portfolio_limit:10m rate=100r/m;

# Geographic distribution zones
geo $geo_region {
    default us-east;
    10.0.0.0/8 us-east;
    172.16.0.0/12 us-east;
    192.168.0.0/16 us-east;
    
    # US West
    8.8.8.8 us-west;
    1.1.1.1 us-west;
    
    # Europe
    1.2.3.4 eu-west;
    5.6.7.8 eu-west;
    
    # Asia
    9.10.11.12 asia-pacific;
    13.14.15.16 asia-pacific;
}

# Upstream definitions with multiple load balancing strategies
# User Service - Round Robin with Health Checks
upstream user_service_rr {
    least_conn;
    server user-service-1:3001 max_fails=3 fail_timeout=30s weight=1;
    server user-service-2:3001 max_fails=3 fail_timeout=30s weight=1;
    server user-service-3:3001 max_fails=3 fail_timeout=30s weight=1;
    server user-service-4:3001 max_fails=3 fail_timeout=30s weight=1;
    keepalive 32;
}

# User Service - Least Connections
upstream user_service_lc {
    least_conn;
    server user-service-1:3001 max_fails=3 fail_timeout=30s;
    server user-service-2:3001 max_fails=3 fail_timeout=30s;
    server user-service-3:3001 max_fails=3 fail_timeout=30s;
    server user-service-4:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Trading Service - Weighted Round Robin
upstream trading_service_wrr {
    least_conn;
    server trading-service-1:3002 max_fails=3 fail_timeout=30s weight=3;
    server trading-service-2:3002 max_fails=3 fail_timeout=30s weight=2;
    server trading-service-3:3002 max_fails=3 fail_timeout=30s weight=1;
    server trading-service-4:3002 max_fails=3 fail_timeout=30s weight=2;
    keepalive 32;
}

# Trading Service - Least Connections
upstream trading_service_lc {
    least_conn;
    server trading-service-1:3002 max_fails=3 fail_timeout=30s;
    server trading-service-2:3002 max_fails=3 fail_timeout=30s;
    server trading-service-3:3002 max_fails=3 fail_timeout=30s;
    server trading-service-4:3002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Portfolio Service - Round Robin
upstream portfolio_service_rr {
    least_conn;
    server portfolio-service-1:3003 max_fails=3 fail_timeout=30s;
    server portfolio-service-2:3003 max_fails=3 fail_timeout=30s;
    server portfolio-service-3:3003 max_fails=3 fail_timeout=30s;
    server portfolio-service-4:3003 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Market Data Service - Least Connections (high frequency)
upstream market_data_service_lc {
    least_conn;
    server market-data-service-1:3004 max_fails=2 fail_timeout=15s;
    server market-data-service-2:3004 max_fails=2 fail_timeout=15s;
    server market-data-service-3:3004 max_fails=2 fail_timeout=15s;
    server market-data-service-4:3004 max_fails=2 fail_timeout=15s;
    keepalive 64;
}

# Notification Service - Sticky Sessions
upstream notification_service_sticky {
    ip_hash; # Sticky sessions based on client IP
    server notification-service-1:3005 max_fails=3 fail_timeout=30s;
    server notification-service-2:3005 max_fails=3 fail_timeout=30s;
    server notification-service-3:3005 max_fails=3 fail_timeout=30s;
    server notification-service-4:3005 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

# Cache Service - Round Robin
upstream cache_service_rr {
    least_conn;
    server cache-service-1:3006 max_fails=3 fail_timeout=30s;
    server cache-service-2:3006 max_fails=3 fail_timeout=30s;
    server cache-service-3:3006 max_fails=3 fail_timeout=30s;
    server cache-service-4:3006 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Geographic distribution upstreams
upstream user_service_us_east {
    least_conn;
    server user-service-1:3001 max_fails=3 fail_timeout=30s;
    server user-service-2:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream user_service_us_west {
    least_conn;
    server user-service-3:3001 max_fails=3 fail_timeout=30s;
    server user-service-4:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream user_service_eu_west {
    least_conn;
    server user-service-5:3001 max_fails=3 fail_timeout=30s;
    server user-service-6:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream user_service_asia_pacific {
    least_conn;
    server user-service-7:3001 max_fails=3 fail_timeout=30s;
    server user-service-8:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Circuit breaker configuration
map $upstream_response_time $circuit_breaker_state {
    ~^[0-9]+\.([0-9]+)$ $1;
    default 0;
}

# Health check configuration
map $request_uri $health_check {
    ~^/health$ 1;
    default 0;
}

# Main server block with enhanced features
server {
    listen 80;
    server_name api.prepx.com;
    
    # Enhanced security headers
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
    
    # CORS headers with enhanced security
    add_header Access-Control-Allow-Origin "https://prepx.com" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-User-ID, X-API-Key, X-Client-Version" always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Max-Age 86400 always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "https://prepx.com";
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH";
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-User-ID, X-API-Key, X-Client-Version";
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Max-Age 86400;
        add_header Content-Type 'text/plain charset=UTF-8';
        add_header Content-Length 0;
        return 204;
    }
    
    # Global rate limiting
    limit_req zone=ip_limit burst=20 nodelay;
    
    # Health check endpoint (no rate limiting)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","timestamp":"$time_iso8601","version":"1.0.0"}';
        add_header Content-Type application/json;
    }
    
    # Detailed health check with service status
    location /health/detailed {
        access_log off;
        return 200 '{"status":"healthy","services":{"user":"up","trading":"up","portfolio":"up","market":"up","cache":"up"},"timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # Circuit breaker status endpoint
    location /circuit-breaker/status {
        access_log off;
        return 200 '{"circuit_breakers":{"user_service":"closed","trading_service":"closed","portfolio_service":"closed","market_data_service":"closed"}}';
        add_header Content-Type application/json;
    }
    
    # API Analytics endpoint
    location /analytics/requests {
        access_log off;
        return 200 '{"total_requests":12345,"success_rate":99.5,"avg_response_time":"45ms","error_rate":0.5}';
        add_header Content-Type application/json;
    }
    
    # User service routes with geographic distribution
    location /api/users/ {
        # Rate limiting per user
        limit_req zone=user_limit burst=30 nodelay;
        
        # Geographic routing
        set $user_upstream $geo_region;
        if ($geo_region = "us-east") {
            set $user_upstream user_service_us_east;
        }
        if ($geo_region = "us-west") {
            set $user_upstream user_service_us_west;
        }
        if ($geo_region = "eu-west") {
            set $user_upstream user_service_eu_west;
        }
        if ($geo_region = "asia-pacific") {
            set $user_upstream user_service_asia_pacific;
        }
        
        # Fallback to round robin if geographic routing fails
        if ($user_upstream = "") {
            set $user_upstream user_service_rr;
        }
        
        proxy_pass http://$user_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $http_x_user_id;
        proxy_set_header X-Client-Version $http_x_client_version;
        
        # Enhanced timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Circuit breaker logic
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
        
        # Request/Response transformation
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Request-Timestamp $time_iso8601;
        
        # Logging for analytics
        access_log /var/log/nginx/api-gateway.log combined;
    }
    
    # Trading service routes with weighted load balancing
    location /api/trading/ {
        # Strict rate limiting for trading
        limit_req zone=trading_limit burst=5 nodelay;
        
        # Authentication check
        auth_request /auth/validate;
        
        proxy_pass http://trading_service_wrr;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $http_x_user_id;
        proxy_set_header X-API-Key $http_x_api_key;
        
        # Extended timeouts for trading operations
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Circuit breaker with retry logic
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 15s;
        
        # Request transformation
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Request-Timestamp $time_iso8601;
        proxy_set_header X-Trading-Session $http_x_trading_session;
        
        # Response transformation headers
        add_header X-Response-Time $upstream_response_time;
        add_header X-Server-Instance $upstream_addr;
        
        access_log /var/log/nginx/trading-gateway.log combined;
    }
    
    # Portfolio service routes
    location /api/portfolio/ {
        limit_req zone=portfolio_limit burst=20 nodelay;
        
        # Authentication check
        auth_request /auth/validate;
        
        proxy_pass http://portfolio_service_rr;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $http_x_user_id;
        
        # Standard timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Error handling
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
        
        access_log /var/log/nginx/portfolio-gateway.log combined;
    }
    
    # Market data service routes (high frequency)
    location /api/market/ {
        limit_req zone=market_data_limit burst=100 nodelay;
        
        proxy_pass http://market_data_service_lc;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Fast timeouts for market data
        proxy_connect_timeout 3s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Aggressive error handling for market data
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 5s;
        
        # Caching headers for market data
        add_header Cache-Control "public, max-age=1";
        add_header X-Cache-Status "MISS";
        
        access_log /var/log/nginx/market-gateway.log combined;
    }
    
    # WebSocket for notifications with sticky sessions
    location /ws/ {
        proxy_pass http://notification_service_sticky;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $http_x_user_id;
        
        # WebSocket specific timeouts
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # WebSocket ping/pong
        proxy_set_header X-WebSocket-Ping-Interval 30;
        
        access_log /var/log/nginx/websocket-gateway.log combined;
    }
    
    # Cache service routes
    location /api/cache/ {
        limit_req zone=api_limit burst=50 nodelay;
        
        proxy_pass http://cache_service_rr;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Fast timeouts for cache operations
        proxy_connect_timeout 3s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Cache-specific error handling
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 5s;
        
        access_log /var/log/nginx/cache-gateway.log combined;
    }
    
    # Authentication validation endpoint
    location = /auth/validate {
        internal;
        proxy_pass http://user_service_rr/api/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header Authorization $http_authorization;
    }
    
    # Default route - return 404 for unknown endpoints
    location / {
        return 404 '{"error": "Endpoint not found", "timestamp": "$time_iso8601", "request_id": "$request_id"}';
        add_header Content-Type application/json;
    }
}

# SSL configuration with enhanced security
server {
    listen 443 ssl http2;
    server_name api.prepx.com;
    
    # SSL certificates
    ssl_certificate /etc/ssl/certs/prepx.crt;
    ssl_certificate_key /etc/ssl/private/prepx.key;
    
    # Enhanced SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # Security headers
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Include the same location blocks as the HTTP server
    include /etc/nginx/conf.d/locations.conf;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name api.prepx.com;
    return 301 https://$server_name$request_uri;
}

# Load balancing configuration for Layer 4
stream {
    # Layer 4 load balancing for database connections
    upstream postgres_cluster {
        least_conn;
        server postgres-primary:5432 max_fails=3 fail_timeout=30s;
        server postgres-replica:5432 max_fails=3 fail_timeout=30s;
    }
    
    # Layer 4 load balancing for Redis
    upstream redis_cluster {
        least_conn;
        server redis-master-1:6379 max_fails=3 fail_timeout=30s;
        server redis-master-2:6379 max_fails=3 fail_timeout=30s;
        server redis-master-3:6379 max_fails=3 fail_timeout=30s;
    }
    
    # Database load balancer
    server {
        listen 5433;
        proxy_pass postgres_cluster;
        proxy_timeout 1s;
        proxy_responses 1;
    }
    
    # Redis load balancer
    server {
        listen 6380;
        proxy_pass redis_cluster;
        proxy_timeout 1s;
        proxy_responses 1;
    }
}
