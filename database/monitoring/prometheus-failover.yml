# Prometheus Configuration for PrepX Database Failover Monitoring

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'prepx-database-cluster'
    replica: 'prometheus-failover'

rule_files:
  - "alert_rules_failover.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s

  # PostgreSQL Primary
  - job_name: 'postgres-primary'
    static_configs:
      - targets: ['postgres-primary:9187']
    scrape_interval: 10s
    metrics_path: /metrics

  # PostgreSQL Standby 1
  - job_name: 'postgres-standby-1'
    static_configs:
      - targets: ['postgres-standby-1:9187']
    scrape_interval: 10s
    metrics_path: /metrics

  # PostgreSQL Standby 2
  - job_name: 'postgres-standby-2'
    static_configs:
      - targets: ['postgres-standby-2:9187']
    scrape_interval: 10s
    metrics_path: /metrics

  # PgBouncer
  - job_name: 'pgbouncer'
    static_configs:
      - targets: ['pgbouncer:9127']
    scrape_interval: 10s
    metrics_path: /metrics

  # HAProxy
  - job_name: 'haproxy'
    static_configs:
      - targets: ['haproxy:8404']
    scrape_interval: 10s
    metrics_path: /stats

  # Failover Manager
  - job_name: 'failover-manager'
    static_configs:
      - targets: ['failover-manager:8080']
    scrape_interval: 30s
    metrics_path: /metrics

  # Node Exporter (System metrics)
  - job_name: 'node-exporter'
    static_configs:
      - targets:
          - 'postgres-primary:9100'
          - 'postgres-standby-1:9100'
          - 'postgres-standby-2:9100'
          - 'pgbouncer:9100'
          - 'haproxy:9100'
          - 'failover-manager:9100'
    scrape_interval: 15s
    metrics_path: /metrics

  # Keepalived
  - job_name: 'keepalived'
    static_configs:
      - targets: ['keepalived:9100']
    scrape_interval: 15s
    metrics_path: /metrics

  # Alert Manager
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
    scrape_interval: 30s
    metrics_path: /metrics

# Remote write configuration for long-term storage
remote_write:
  - url: "https://your-thanos-receive-endpoint/api/v1/receive"
    basic_auth:
      username: "thanos"
      password: "${THANOS_PASSWORD}"

# Storage configuration
storage:
  tsdb:
    retention.time: 30d
    retention.size: 100GB
