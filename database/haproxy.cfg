# HAProxy Configuration for PrepX Database Failover
# Provides high availability load balancing for PostgreSQL

global
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4000
    tune.ssl.default-dh-param 2048

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    maxconn 3000

# Statistics page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:admin123

# Frontend for PostgreSQL connections
frontend postgres_frontend
    bind *:5432
    mode tcp
    default_backend postgres_backend

# Backend for PostgreSQL with failover
backend postgres_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Health check for PostgreSQL
    option tcp-check
    
    # Primary database server
    server postgres-primary postgres-primary:5432 check port 5432 inter 5s rise 2 fall 3
    server postgres-standby-1 postgres-standby-1:5432 check port 5432 inter 5s rise 2 fall 3 backup
    server postgres-standby-2 postgres-standby-2:5432 check port 5432 inter 5s rise 2 fall 3 backup

# Frontend for PgBouncer connections
frontend pgbouncer_frontend
    bind *:6432
    mode tcp
    default_backend pgbouncer_backend

# Backend for PgBouncer with failover
backend pgbouncer_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # PgBouncer servers
    server pgbouncer-1 pgbouncer:6432 check port 6432 inter 5s rise 2 fall 3

# Frontend for read-only connections
frontend postgres_readonly_frontend
    bind *:5433
    mode tcp
    default_backend postgres_readonly_backend

# Backend for read-only connections
backend postgres_readonly_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Read-only servers
    server postgres-standby-1 postgres-standby-1:5432 check port 5432 inter 5s rise 2 fall 3
    server postgres-standby-2 postgres-standby-2:5432 check port 5432 inter 5s rise 2 fall 3

# Frontend for HTTPS connections
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/prepx.crt
    mode http
    redirect scheme https if !{ ssl_fc }
    default_backend api_backend

# Backend for API connections
backend api_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    
    # API servers (would be your application servers)
    # server api-1 api-server-1:3000 check port 3000 inter 5s rise 2 fall 3
    # server api-2 api-server-2:3000 check port 3000 inter 5s rise 2 fall 3

# Frontend for HTTP connections (redirect to HTTPS)
frontend http_frontend
    bind *:80
    mode http
    redirect scheme https code 301

# Logging configuration
global
    log 127.0.0.1:514 local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4000

# Default settings for all sections
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    maxconn 3000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Health check configuration
defaults
    option tcp-check
    tcp-check connect port 5432
    tcp-check send-binary 00000020
    tcp-check expect binary 52

# Load balancing algorithm
defaults
    balance roundrobin
    option redispatch

# Connection limits
defaults
    maxconn 3000
    timeout connect 10s
    timeout client 1m
    timeout server 1m

# SSL configuration
defaults
    ssl-default-bind-ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options no-sslv3 no-tls-tickets

# Monitoring and alerting
defaults
    option log-health-checks
    option log-separate-errors

# Performance tuning
defaults
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 1024

# Security settings
defaults
    option dontlognull
    option redispatch
    retries 3
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    maxconn 3000

# Error handling
defaults
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
